# Архитектура проекта RiskAnalyzerBot

## Общая структура

Проект следует модульной архитектуре с четким разделением ответственности между компонентами.

## Компоненты системы

### 1. Конфигурация и логирование

**config.py**
- Загрузка переменных окружения из `.env`
- Валидация обязательных параметров
- Управление путями к временным файлам

**logger.py**
- Настройка централизованного логирования
- Кастомный форматтер с поддержкой UserID
- Уровни логирования (DEBUG, INFO, WARNING, ERROR)

### 2. Обработчики Telegram (handlers/)

**file_handler.py**
- Валидация загружаемых файлов
- Координация процесса обработки
- Интеграция всех процессоров
- Обработка ошибок на уровне файлов

**message_handler.py**
- Обработка команд (`/start`, `/help`)
- Обработка текстовых сообщений
- Пользовательский интерфейс

### 3. Процессоры данных (processors/)

**excel_reader.py**
- Чтение Excel файлов (openpyxl)
- Поиск параметров по тексту в ячейках
- Извлечение структурированных данных
- Валидация наличия обязательных данных

**ai_client.py**
- Формирование промпта для ИИ
- HTTP-запросы к FastAPI сервису
- Обработка ответов API
- Fallback механизм при недоступности API

**risk_calculator.py**
- Количественная оценка рисков (risk_score 0-100)
- Преобразование score в уровень риска
- Fallback расчет при недоступности API

**report_generator.py**
- Создание нового листа в Excel
- Форматирование таблиц и данных
- Генерация отчета с результатами анализа

### 4. Утилиты (utils/)

**cleanup.py**
- Удаление временных файлов
- Периодическая очистка старых файлов
- Управление жизненным циклом файлов

## Поток данных

```
Пользователь → Telegram Bot → file_handler
                                    ↓
                            excel_reader (извлечение данных)
                                    ↓
                            ai_client (анализ рисков)
                                    ↓
                            report_generator (создание отчета)
                                    ↓
                            Telegram Bot → Пользователь
                                    ↓
                            cleanup (удаление временных файлов)
```

## Обработка ошибок

Система использует многоуровневую обработку ошибок:

1. **Валидация на входе** - проверка формата файла
2. **Обработка в процессорах** - специфичные ошибки для каждого модуля
3. **Fallback механизмы** - резервные варианты при сбоях
4. **Логирование** - все ошибки логируются с полным traceback
5. **Пользовательские сообщения** - понятные сообщения об ошибках

## Безопасность

- Секретные данные хранятся в `.env` (исключены из Git)
- Временные файлы автоматически удаляются
- Валидация всех входных данных
- Обработка исключений на всех уровнях

## Масштабируемость

Архитектура позволяет легко:
- Добавлять новые процессоры
- Расширять функциональность обработчиков
- Интегрировать дополнительные источники данных
- Модифицировать формат отчетов

## Зависимости

- `python-telegram-bot` - работа с Telegram API
- `openpyxl` - работа с Excel файлами
- `pandas` - обработка данных (резерв)
- `requests` - HTTP-запросы к API
- `python-dotenv` - загрузка переменных окружения

