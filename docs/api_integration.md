# Интеграция с API ИИ-сервиса

## Обзор

Бот интегрируется с кастомным FastAPI сервисом для анализа рисков инфраструктурных проектов.

## Формат запроса

### Endpoint
```
POST {AI_API_URL}/analyze
```

### Headers
```http
Content-Type: application/json
Accept: application/json
Authorization: Bearer {AI_API_KEY}  # Если требуется
Origin: RiskAnalyzerBot
```

### Body (JSON)
```json
{
  "project_parameters": {
    "type": "Метро",
    "capex": 500,
    "construction_years": 3,
    "debt_share": 30,
    "debt_rate": 20,
    "discount_rate": 25
  },
  "model_results": {
    "npv": 152,
    "irr": 30,
    "payback_period": 6
  },
  "prompt": "Текст промпта для ИИ..."
}
```

## Формат ответа

### Успешный ответ (200 OK)

```json
{
  "risk_level": "Средний",
  "reason": "Высокая ставка дисконтирования компенсируется существенными доходами проекта. Риски связаны с чувствительностью к изменению тарифов.",
  "critical_factors": [
    "Ставка дисконтирования",
    "Рост операционных расходов"
  ],
  "scenarios": [
    {
      "name": "Превышение бюджета на 30%",
      "description": "Увеличение стоимости строительства из-за роста цен на материалы",
      "npv_impact": -150,
      "irr_impact": -5,
      "probability": "Средняя",
      "potential_losses": 150
    },
    {
      "name": "Задержка сроков на 2 года",
      "description": "Задержка ввода объекта в эксплуатацию",
      "npv_impact": -80,
      "irr_impact": -3,
      "probability": "Низкая",
      "potential_losses": 80
    }
  ],
  "total_potential_losses": 230,
  "risk_mitigation": [
    "Создание резервного фонда на случай превышения бюджета",
    "Заключение фиксированных контрактов с подрядчиками",
    "Страхование строительных рисков"
  ]
}
```

### Поля ответа

- **risk_level** (string, обязательное): Уровень риска - "Низкий", "Средний", "Высокий", "Критический"
- **reason** (string, обязательное): Развернутое обоснование оценки (2-4 предложения)
- **critical_factors** (array[string], обязательное): Массив критических факторов риска
- **scenarios** (array[object], опциональное): Массив сценариев непредвиденных ситуаций
  - **name** (string): Название сценария
  - **description** (string): Описание ситуации
  - **npv_impact** (number): Влияние на NPV в млн руб (может быть отрицательным)
  - **irr_impact** (number): Влияние на IRR в процентах (может быть отрицательным)
  - **probability** (string): Вероятность - "Низкая", "Средняя", "Высокая"
  - **potential_losses** (number): Потенциальные убытки в млн руб
- **total_potential_losses** (number, опциональное): Суммарные потенциальные убытки в млн руб
- **risk_mitigation** (array[string], опциональное): Рекомендации по снижению рисков

## Обработка ошибок

### HTTP 500 / 503
Бот получает сообщение об ошибке сервера и использует fallback механизм (локальный расчет рисков).

### Timeout
При превышении времени ожидания (по умолчанию 180 секунд) бот использует fallback механизм.

### Невалидный JSON
Бот логирует ошибку и возвращает пользователю сообщение об ошибке.

## CORS заголовки

Если API требует CORS заголовки, они включаются в запрос:

- **Origin**: RiskAnalyzerBot
- **Access-Control-Allow-Origin**: Настраивается на стороне API
- **Access-Control-Allow-Methods**: POST
- **Access-Control-Allow-Headers**: Content-Type, Authorization

## Промпт для ИИ

Промпт формируется динамически на основе данных проекта и включает:

1. Контекст задачи (эксперт по анализу рисков)
2. Входные данные проекта
3. Результаты финансовой модели
4. Инструкции по анализу
5. Требования к формату ответа
6. Запрос на анализ сценариев непредвиденных ситуаций

Подробный текст промпта генерируется в `processors/ai_client.py`.

## Fallback механизм

При недоступности API бот использует локальный расчет рисков (`processors/risk_calculator.py`):

- Количественная оценка risk_score (0-100)
- Преобразование в уровень риска
- Базовое определение критических факторов
- Упрощенный формат ответа (без сценариев)

## Тестирование

Для тестирования интеграции можно использовать mock API или заглушки. Примеры тестов находятся в `tests/test_ai_client.py`.

